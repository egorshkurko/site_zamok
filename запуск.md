# Установка

cd /root/site_zamok_git

# Отменить локальные изменения (если не нужны)
git reset --hard HEAD

# Получить обновления с GitHub
git pull origin main

# Пересоздать venv с правильным Python
rm -rf venv
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
deactivate
sudo systemctl restart gunicorn


# После изменений
source venv/bin/activate
python manage.py migrate
sudo systemctl restart gunicorn

## 1. Логи Gunicorn

sudo journalctl -u gunicorn -n 100 --no-pager

## 2. Логи Django (если настроены)

```bash
# Если логи Django в файле
tail -f /path/to/django.log

# Или в syslog
tail -f /var/log/syslog | grep django
```

## 3. Логи через Python

Включите подробное логирование в `settings.py`:

```python
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'file': {
            'level': 'ERROR',
            'class': 'logging.FileHandler',
            'filename': '/path/to/django_errors.log',
        },
        'console': {
            'level': 'ERROR',
            'class': 'logging.StreamHandler',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file', 'console'],
            'level': 'ERROR',
            'propagate': True,
        },
    },
}
```

## 4. Включить DEBUG режим временно

В `settings.py` на сервере (только для отладки!):
```python
DEBUG = True
```

Тогда Django покажет полный traceback ошибки на странице.

**⚠️ ВАЖНО:** Не забудьте вернуть `DEBUG = False` после отладки!

## 5. Проверить через Python shell

```bash
cd /path/to/project
source venv/bin/activate
python manage.py shell
```

Затем попробуйте выполнить код вручную:
```python
from mainapp.models import Review
from django.utils import timezone
from datetime import timedelta

# Проверьте, что поле ip_address существует
review = Review.objects.first()
print(review.ip_address)  # Не должно быть ошибки
```

## 6. Проверить миграции

```bash
python manage.py showmigrations
python manage.py migrate --plan
```

## 7. Типичные ошибки на старой версии

### Ошибка 1: EmailMessage вместо EmailMultiAlternatives
**Симптом:** `'EmailMessage' object has no attribute 'attach_alternative'`
**Решение:** Использовать `EmailMultiAlternatives`

### Ошибка 2: Отсутствие поля ip_address
**Симптом:** `Review() got an unexpected keyword argument 'ip_address'`
**Решение:** Применить миграцию `0006_review_ip_address.py`

### Ошибка 3: Отсутствие шаблонов email
**Симптом:** `TemplateDoesNotExist: review_notification.html`
**Решение:** Создать шаблоны `review_notification.html` и `review_notification.txt`

### Ошибка 4: Ошибка отправки email
**Симптом:** `(554, b'5.7.1 Message rejected under suspicion of SPAM')`
**Решение:** Улучшить форматирование письма (уже сделано)

## 8. Быстрая проверка через curl

```bash
# Проверить, что сервер отвечает
curl -I http://185.221.153.228:8000/otziv/

# Попробовать отправить POST запрос (для теста)
curl -X POST http://185.221.153.228:8000/otziv/ \
  -d "name=Test&text=Test review&rating=5" \
  -H "Content-Type: application/x-www-form-urlencoded"
```

## 9. Проверить права доступа

```bash
# Проверить права на файлы
ls -la /path/to/project

# Проверить права на базу данных
ls -la /path/to/db.sqlite3
```

## 10. Проверить зависимости

```bash
# Убедиться, что все пакеты установлены
pip list | grep -i django
pip list | grep -i gunicorn
```

